<!-- c:\0124newSIm\src\templates\sales.html -->
{% extends "base.html" %}

{% block content %}
<div class="dashboard-grid">
    <!-- 自社在庫サマリ -->
    <div class="card card-large">
        <div class="card-header">
            <h2>自社の販売可能在庫 (Total: {{ "{:,}".format(total_inventory) }}台)</h2>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>製品名</th>
                        <th>在庫数</th>
                        <th>販売価格 (MSRP)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in my_inventory %}
                    <tr>
                        <td><a href="{{ url_for('product_detail', design_id=item.design_id) }}" style="color: #4db8ff;">{{ item.product_name }}</a></td>
                        <td>{{ "{:,}".format(item.quantity) }}</td>
                        <td>¥{{ "{:,}".format(item.sales_price) }}</td>
                        <td>
                            <form action="{{ url_for('sales_pricing') }}" method="post" style="display: flex; gap: 5px;">
                                <input type="hidden" name="design_id" value="{{ item.design_id }}"> <!-- inventoryテーブルにはdesign_idがある前提 -->
                                <input type="number" name="new_price" class="form-control" style="width: 100px; padding: 4px;" placeholder="新価格" value="{{ item.sales_price }}">
                                <button type="submit" class="btn btn-small btn-secondary">改定</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4">在庫がありません。</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 受注待ちリスト -->
    <div class="card card-large">
        <div class="card-header">
            <h2>B2B 受注依頼 (Pending Orders)</h2>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>発注元</th>
                        <th>製品</th>
                        <th>数量</th>
                        <th>金額</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in pending_orders %}
                    <tr>
                        <td><a href="{{ url_for('company_detail', company_id=order.buyer_id) }}" style="color: #4db8ff;">{{ order.buyer_name }}</a></td>
                        <td><a href="{{ url_for('product_detail', design_id=order.design_id) }}" style="color: #4db8ff;">{{ order.product_name }}</a></td>
                        <td>{{ order.quantity }}</td>
                        <td>¥{{ "{:,}".format(order.amount) }}</td>
                        <td>
                            <form action="{{ url_for('sales_action') }}" method="post" style="display:inline;">
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                <button type="submit" name="action" value="accept" class="btn btn-small btn-primary">受注</button>
                                <button type="submit" name="action" value="reject" class="btn btn-small btn-danger">拒否</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5">現在、新しい注文はありません。</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 取引履歴 -->
    <div class="card card-large">
        <div class="card-header">
            <h2>最近の取引履歴</h2>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>時期</th>
                        <th>取引先</th>
                        <th>製品</th>
                        <th>数量</th>
                        <th>金額</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in history %}
                    <tr>
                        <td>{{ item.week | format_week }}</td>
                        <td>{{ item.partner_name }}</td> <!-- ID取得が複雑なため今回はテキストのまま -->
                        <td><a href="{{ url_for('product_detail', design_id=item.design_id) }}" style="color: #4db8ff;">{{ item.product_name }}</a></td>
                        <td>{{ item.quantity }}</td>
                        <td>¥{{ "{:,}".format(item.amount) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
