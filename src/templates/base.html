<!-- c:\0124newSIm\src\templates\base.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewSim - {{ player.name if player else 'Game' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="logo-area tooltip-container">
                <h1>
                    {{ player.name if player else '自社名' }}
                    {% if player %}
                    <span style="font-size: 0.6em; color: #4db8ff; margin-left: 15px; font-weight: normal;">¥{{ "{:,}".format(player.funds|int) }}</span>
                    {% endif %}
                </h1>
                
                {% if player and header_caps %}
                <div class="tooltip-content">
                    <div class="tooltip-section">
                        <div class="tooltip-row">
                            <span style="color: var(--text-muted);">組織安定性</span>
                            <span style="font-weight: bold;">{{ header_caps.stability|int }}</span>
                        </div>
                    </div>
                    
                    <div class="tooltip-section">
                        <table class="tooltip-table">
                            <thead>
                                <tr>
                                    <th>部署</th>
                                    <th style="text-align: right;">能力</th>
                                    <th style="text-align: right;">Cap</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set header_stats_list = [
                                    ('生産', 'production'),
                                    ('開発', 'development'),
                                    ('営業', 'sales'),
                                    ('店舗', 'store_ops'),
                                    ('人事', 'hr'),
                                    ('広報', 'pr'),
                                    ('経理', 'accounting')
                                ] %}
                                {% for label, key in header_stats_list %}
                                <tr>
                                    <td>{{ label }}</td>
                                    <td style="color: #4db8ff;">{{ header_caps[key]|int }}</td>
                                    <td>{{ header_caps[key + '_capacity']|int }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="tooltip-section">
                        <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px;">施設稼働 ({{ npc_scale }}人/NPC)</div>
                        {% for key, fac in header_caps.facilities.items() %}
                        <div class="tooltip-row">
                            <span>{{ fac.name }}</span>
                            <span class="{{ 'text-danger' if fac.usage > fac.limit else '' }}">
                                {{ fac.usage }} / {{ fac.limit }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <nav class="top-nav">
                <a href="{{ url_for('dashboard') }}" class="{{ 'active' if active_page == 'dashboard' else '' }}">ダッシュボード</a>
                <a href="{{ url_for('production') }}" class="{{ 'active' if active_page == 'production' else '' }}">生産部</a>
                <a href="{{ url_for('store') }}" class="{{ 'active' if active_page == 'store' else '' }}">店舗</a>
                <a href="{{ url_for('sales') }}" class="{{ 'active' if active_page == 'sales' else '' }}">営業部</a>
                <a href="{{ url_for('hr') }}" class="{{ 'active' if active_page == 'hr' else '' }}">人事部</a>
                <a href="{{ url_for('dev') }}" class="{{ 'active' if active_page == 'dev' else '' }}">開発部</a>
                <a href="{{ url_for('pr') }}" class="{{ 'active' if active_page == 'pr' else '' }}">広報部</a>
                <a href="{{ url_for('facility') }}" class="{{ 'active' if active_page == 'facility' else '' }}">施設</a>
                <a href="{{ url_for('finance') }}" class="{{ 'active' if active_page == 'finance' else '' }}">財務</a>
                <a href="{{ url_for('world') }}" class="{{ 'active' if active_page == 'world' else '' }}">世界</a>
            </nav>
            <div class="action-area">
                <div class="date-display">{{ date_str }}</div>
                <form action="{{ url_for('next_week') }}" method="post">
                    <button type="submit" class="btn-next-week">進める</button>
                </form>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            {% block content %}
            <div class="placeholder-content">
                {{ content }}
            </div>
            {% endblock %}
        </main>
    </div>
    
    <script>
        // 共通のJavaScript処理
        document.addEventListener('DOMContentLoaded', () => {
            // フラッシュメッセージの自動消去
            setTimeout(() => {
                const flashes = document.querySelectorAll('.flash-message');
                flashes.forEach(f => f.style.opacity = '0');
            }, 3000);
        });

        // テーブルソート機能
        function sortTable(header, colIndex, type = 'string') {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAsc = !header.classList.contains('asc');
            
            // ヘッダーのクラス更新
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            header.classList.toggle('asc', isAsc);
            header.classList.toggle('desc', !isAsc);

            rows.sort((a, b) => {
                const cellA = a.children[colIndex];
                const cellB = b.children[colIndex];
                
                // data-value属性があればそれを優先、なければテキスト
                let valA = cellA.getAttribute('data-value');
                let valB = cellB.getAttribute('data-value');
                
                if (valA === null) valA = cellA.innerText.trim();
                if (valB === null) valB = cellB.innerText.trim();

                if (type === 'number') {
                    // 数値変換（範囲表示 "50-54" の場合は下限値でソート）
                    const numA = parseFloat(valA.split('-')[0].replace(/[^0-9.-]/g, '')) || 0;
                    const numB = parseFloat(valB.split('-')[0].replace(/[^0-9.-]/g, '')) || 0;
                    return isAsc ? numA - numB : numB - numA;
                } else {
                    return isAsc ? valA.localeCompare(valB, 'ja') : valB.localeCompare(valA, 'ja');
                }
            });

            // DOM並べ替え
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
