<!-- c:\0124newSIm\src\templates\base.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewSim - {{ player.name if player else 'Game' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo-area">
                <h1>
                    {{ player.name if player else '自社名' }}
                </h1>
            </div>
            <nav class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}" class="{{ 'active' if active_page == 'dashboard' else '' }}">ダッシュボード</a>
                <div style="margin: 10px 20px; font-size: 11px; color: #666; text-transform: uppercase;">Operations</div>
                <a href="{{ url_for('production') }}" class="{{ 'active' if active_page == 'production' else '' }}">生産部 (Production)</a>
                <a href="{{ url_for('store') }}" class="{{ 'active' if active_page == 'store' else '' }}">店舗運営 (Store)</a>
                <a href="{{ url_for('sales') }}" class="{{ 'active' if active_page == 'sales' else '' }}">営業・B2B (Sales)</a>
                <a href="{{ url_for('dev') }}" class="{{ 'active' if active_page == 'dev' else '' }}">開発部 (R&D)</a>
                
                <div style="margin: 10px 20px; font-size: 11px; color: #666; text-transform: uppercase;">Management</div>
                <a href="{{ url_for('hr') }}" class="{{ 'active' if active_page == 'hr' else '' }}">人事部 (HR)</a>
                <a href="{{ url_for('hire_page') }}" class="{{ 'active' if active_page == 'hire_page' else '' }}">採用 (Hiring)</a>
                <a href="{{ url_for('finance') }}" class="{{ 'active' if active_page == 'finance' else '' }}">財務 (Finance)</a>
                <a href="{{ url_for('ir') }}" class="{{ 'active' if active_page == 'ir' else '' }}">IR・株式 (Stock)</a>
                <a href="{{ url_for('facility') }}" class="{{ 'active' if active_page == 'facility' else '' }}">施設管理 (Facility)</a>
                <a href="{{ url_for('pr') }}" class="{{ 'active' if active_page == 'pr' else '' }}">広報 (PR)</a>
                
                <div style="margin: 10px 20px; font-size: 11px; color: #666; text-transform: uppercase;">Market</div>
                <a href="{{ url_for('world') }}" class="{{ 'active' if active_page == 'world' else '' }}">世界情勢 (World)</a>
            </nav>
            <div class="sidebar-footer">
                <div style="font-size: 11px; color: #666;">NewSim v0.1</div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="content-wrapper">
            <!-- Top Status Bar -->
            <header class="top-header">
                <div class="status-indicators tooltip-container">
                    {% if player %}
                    <div class="status-item">
                        <span class="status-label">現金残高</span>
                        <span class="status-value" style="color: #4db8ff;">¥{{ "{:,}".format(player.funds|int) }}</span>
                    </div>
                    {% if player.stock_price %}
                    <div class="status-item">
                        <span class="status-label">株価</span>
                        <span class="status-value" style="color: #b2ff59;">¥{{ "{:,}".format(player.stock_price) }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Tooltip for Capabilities (Moved from old header) -->
                    {% if header_caps %}
                    <div class="tooltip-content">
                        <div class="tooltip-section">
                            <div class="tooltip-row">
                                <span style="color: var(--text-muted);">組織安定性</span>
                                <span style="font-weight: bold;">{{ header_caps.stability|int }}</span>
                            </div>
                        </div>
                        <div class="tooltip-section">
                            <table class="tooltip-table">
                                <thead>
                                    <tr>
                                        <th>部署</th>
                                        <th style="text-align: right;">能力</th>
                                        <th style="text-align: right;">Cap</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set header_stats_list = [
                                        ('生産', 'production'),
                                        ('開発', 'development'),
                                        ('営業', 'sales'),
                                        ('店舗', 'store_ops'),
                                    ('人事', 'hr'),
                                    ('広報', 'pr'),
                                    ('経理', 'accounting')
                                ] %}
                                {% for label, key in header_stats_list %}
                                <tr>
                                    <td>{{ label }}</td>
                                    <td style="color: #4db8ff;">{{ header_caps[key]|int }}</td>
                                    <td>
                                        {{ header_caps[key + '_capacity']|int }}
                                        {% if header_caps.requirements.get(key) is not none %}
                                        <span style="font-size: 0.8em; color: #aaa;">({{ header_caps.requirements[key]|int }})</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="tooltip-section">
                        <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px;">施設稼働 ({{ npc_scale }}人/NPC)</div>
                        {% for key, fac in header_caps.facilities.items() %}
                        <div class="tooltip-row">
                            <span>{{ fac.name }}</span>
                            <span class="{{ 'text-danger' if fac.usage > fac.limit else '' }}">
                                {{ fac.usage }} / {{ fac.limit }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <div class="action-area">
                    <div class="date-display">{{ date_str }}</div>
                    <form action="{{ url_for('next_week') }}" method="post">
                        <button type="submit" class="btn-next-week">NEXT WEEK &raquo;</button>
                    </form>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages">
                            {% for category, message in messages %}
                                <div class="flash-message {{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                {% block content %}
                <div class="placeholder-content">
                    {{ content }}
                </div>
                {% endblock %}
            </main>
        </div>
    </div>
    
    <script>
        // 共通のJavaScript処理
        document.addEventListener('DOMContentLoaded', () => {
            // フラッシュメッセージの自動消去
            setTimeout(() => {
                const flashes = document.querySelectorAll('.flash-message');
                flashes.forEach(f => f.style.opacity = '0');
            }, 3000);
        });

        // テーブルソート機能
        function sortTable(header, colIndex, type = 'string') {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAsc = !header.classList.contains('asc');
            
            // ヘッダーのクラス更新
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            header.classList.toggle('asc', isAsc);
            header.classList.toggle('desc', !isAsc);

            rows.sort((a, b) => {
                const cellA = a.children[colIndex];
                const cellB = b.children[colIndex];
                
                // data-value属性があればそれを優先、なければテキスト
                let valA = cellA.getAttribute('data-value');
                let valB = cellB.getAttribute('data-value');
                
                if (valA === null) valA = cellA.innerText.trim();
                if (valB === null) valB = cellB.innerText.trim();

                if (type === 'number') {
                    // 数値変換（範囲表示 "50-54" の場合は下限値でソート）
                    const numA = parseFloat(valA.split('-')[0].replace(/[^0-9.-]/g, '')) || 0;
                    const numB = parseFloat(valB.split('-')[0].replace(/[^0-9.-]/g, '')) || 0;
                    return isAsc ? numA - numB : numB - numA;
                } else {
                    return isAsc ? valA.localeCompare(valB, 'ja') : valB.localeCompare(valA, 'ja');
                }
            });

            // DOM並べ替え
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
