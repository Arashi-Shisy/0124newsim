<!-- c:\0124newSIm\src\templates\hr.html -->
{% extends "base.html" %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <h2>企業能力レポート</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
            <div style="text-align: center; padding: 10px; background: var(--bg-header); border-radius: 8px; border: 1px solid var(--border-color);">
                <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px;">組織安定性 (勤勉さ平均)</div>
                <div style="font-size: 1.4em; font-weight: bold; color: var(--text-main);">{{ caps.stability|int }}</div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            {% set hr_stats_list = [
                ('生産', 'production', 'production'),
                ('開発', 'development', 'development'),
                ('営業', 'sales', 'sales'),
                ('店舗', 'store_ops', 'store'),
                ('人事', 'hr', 'hr'),
                ('広報', 'pr', 'pr'),
                ('経理', 'accounting', 'accounting')
            ] %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                {% for label, cap_key, dept_key in hr_stats_list %}
                <div style="background: var(--bg-header); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    <h3 style="margin: 0 0 12px 0; font-size: 1.1em; color: var(--text-main); border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">{{ label }}</h3>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                        <span style="color: var(--text-muted); font-size: 0.9em;">能力値</span>
                        <span style="font-weight: bold; font-size: 1.2em; color: #4db8ff;">{{ caps[cap_key]|int }}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                        <span style="color: var(--text-muted); font-size: 0.9em;">Capacity</span>
                        <span style="font-weight: bold; color: var(--text-main);">
                            {{ caps[cap_key + '_capacity']|int }}
                            {% if caps.requirements.get(cap_key) is not none %}
                            <span style="font-size: 0.8em; color: var(--text-muted);"> / Req: {{ caps.requirements[cap_key]|int }}</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="color: var(--text-muted); font-size: 0.85em;">人数</span>
                            <span style="font-weight: bold; color: var(--text-main);">{{ dept_stats[dept_key].count }}名</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-muted); font-size: 0.85em;">Space</span>
                            <span style="color: var(--text-main);">{{ dept_stats[dept_key].space }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 事業部別能力レポート -->
        {% if caps.divisions %}
        <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <h3 style="margin-bottom: 15px; color: #d0d0ff;">事業部別能力 (Divisional Capabilities)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                {% for div_id, div_cap in caps.divisions.items() %}
                <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-main);">{{ div_cap.name }}</h4>
                    <table class="tooltip-table">
                        <tr>
                            <td>生産 (Production)</td>
                            <td style="color: #4db8ff;">{{ div_cap.production|int }}</td>
                            <td>Cap: {{ div_cap.get('production_capacity', 0)|int }}</td>
                        </tr>
                        <tr>
                            <td>開発 (Development)</td>
                            <td style="color: #4db8ff;">{{ div_cap.development|int }}</td>
                            <td>Cap: {{ div_cap.get('development_capacity', 0)|int }} <span style="font-size:0.8em; color:#aaa;">(Req: {{ div_cap.requirements.development|int }})</span></td>
                        </tr>
                        <tr>
                            <td>営業 (Sales)</td>
                            <td style="color: #4db8ff;">{{ div_cap.sales|int }}</td>
                            <td>Cap: {{ div_cap.get('sales_capacity', 0)|int }} <span style="font-size:0.8em; color:#aaa;">(Req: {{ div_cap.requirements.sales|int }})</span></td>
                        </tr>
                        <tr>
                            <td>店舗 (Store)</td>
                            <td style="color: #4db8ff;">{{ div_cap.store_ops|int }}</td>
                            <td>Cap: {{ div_cap.get('store_ops_capacity', 0)|int }}</td>
                        </tr>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- 施設稼働状況 -->
        <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
            <h4 style="margin-bottom: 10px; font-size: 1em; color: var(--text-muted);">施設稼働状況 <span style="font-size: 0.8em; font-weight: normal;">(NPC 1名につき {{ npc_scale }} 人分のスペースを使用)</span></h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                {% for key, fac in caps.facilities.items() %}
                <div style="padding: 10px; border-radius: 8px; border: 1px solid {{ 'var(--accent-pink)' if fac.usage > fac.limit else 'var(--border-color)' }}; background: {{ 'rgba(233, 69, 96, 0.1)' if fac.usage > fac.limit else 'var(--bg-header)' }};">
                    <div style="font-weight: bold; color: var(--text-main);">{{ fac.name }}</div>
                    <div style="font-size: 0.9em; color: var(--text-main);">
                        使用: {{ fac.usage }} (NPC:{{ fac.npc_count }}名) / {{ fac.limit }}
                        {% if fac.usage > fac.limit %}
                        <span style="color: var(--accent-pink); font-weight: bold;">(Over)</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 0.8em; color: var(--text-muted);">
                        効率: {{ (fac.efficiency * 100)|int }}%
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="action-bar">
    <div class="action-buttons">
        <!-- 選択した従業員に対するアクションボタン -->
        <button class="btn btn-secondary" onclick="openDeptModal()">配属変更</button>
        <button class="btn btn-secondary" onclick="openSalaryModal()">給与変更</button>
        <button class="btn btn-danger" onclick="openFireModal()">解雇</button>
        <a href="{{ url_for('hire_page') }}" class="btn btn-primary" style="margin-left: 20px;">新規採用画面へ</a>
    </div>
</div>

<!-- 従業員リスト -->
<div>
    <!-- 従業員フィルタ -->
    <div class="filter-container" style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <span style="font-weight: bold; color: var(--text-muted);">絞り込み:</span>
        <select id="emp-filter-dept" class="form-control" style="width: auto; padding: 4px; font-size: 13px;" onchange="filterEmployees()">
            <option value="">全部署</option>
            {% for dept in departments %}<option value="{{ dept }}">{{ dept }}</option>{% endfor %}
        </select>
        <select id="emp-filter-role" class="form-control" style="width: auto; padding: 4px; font-size: 13px;" onchange="filterEmployees()">
            <option value="">全役職</option>
            <option value="member">メンバー</option>
            <option value="assistant_manager">部長補佐</option>
            <option value="manager">部長</option>
            <option value="cxo">CxO</option>
        </select>
        <input type="text" id="emp-filter-name" class="form-control" style="width: 150px; padding: 4px; font-size: 13px;" placeholder="氏名検索" onkeyup="filterEmployees()">
    </div>

    <!-- 役員リスト -->
    <h3 style="margin-bottom: 10px; color: #d0d0ff;">役員 (Executives)</h3>
    <div class="table-container" style="margin-bottom: 30px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 30px;" class="no-sort"></th>
                    <th>管掌 (Dept)</th>
                    <th>事業部</th>
                    <th>役職</th>
                    <th>氏名</th>
                    <th>年齢</th>
                    <th>給与</th>
                    <th>忠誠度</th>
                    <th>マネジメント</th>
                    <th>役員適正</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees if emp.role in ['ceo', 'cxo'] %}
                {% set ns = namespace(div_name='共通部門') %}
                {% for d in player_divisions %}{% if d.id == emp.division_id %}{% set ns.div_name = d.name %}{% endif %}{% endfor %}
                <tr onclick="selectRow(this, '{{ emp.id }}', '{{ emp.name }}', '{{ emp.department }}', '{{ emp.role }}', '{{ emp.salary }}', '{{ emp.division_id }}')" data-dept="{{ emp.department }}" data-role="{{ emp.role }}" data-name="{{ emp.name }}">
                    <td><input type="radio" name="selected_emp" value="{{ emp.id }}"></td>
                    <td>{{ emp.department }}</td>
                    <td>{{ ns.div_name }}</td>
                    <td>{{ emp.role }}</td>
                    <td><a href="{{ url_for('npc_detail', npc_id=emp.id) }}" style="color: #4db8ff; font-weight: bold;" onclick="event.stopPropagation()">{{ emp.name }}</a></td>
                    <td>{{ emp.age }}</td>
                    <td data-value="{{ emp.salary }}">¥{{ "{:,.2f}M".format(emp.salary / 1000000) }}</td>
                    <td data-value="{{ emp.loyalty }}">
                        <div class="bar-container">
                            <div class="bar-fill" style="width: {{ emp.loyalty }}%; background-color: {{ '#e94560' if emp.loyalty < 40 else '#0f3460' }};"></div>
                            <span class="bar-text">{{ emp.loyalty|int }}</span>
                        </div>
                    </td>
                    <td data-value="{{ emp.management | perceived_value(hr_power) }}">{{ emp.management | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.executive | perceived_value(hr_power) }}">{{ emp.executive | ability_range_colored(hr_power) }}</td>
                </tr>
                {% else %}
                <tr><td colspan="9">役員はいません。</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 一般従業員リスト -->
    <h3 style="margin-bottom: 10px; color: #d0d0ff;">従業員 (Employees)</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 30px;" class="no-sort"></th>
                    <th class="sortable" onclick="sortTable(this, 1)">配属</th>
                    <th class="sortable" onclick="sortTable(this, 2)">事業部</th>
                    <th class="sortable" onclick="sortTable(this, 3)">役職</th>
                    <th class="sortable" onclick="sortTable(this, 4)">氏名</th>
                    <th class="sortable" onclick="sortTable(this, 5, 'number')">年齢</th>
                    <th class="sortable" onclick="sortTable(this, 6, 'number')">給与</th>
                    <th class="sortable" onclick="sortTable(this, 7, 'number')">忠誠度</th>
                    <th class="sortable" onclick="sortTable(this, 8, 'number')">勤勉さ</th>
                    <th class="sortable" onclick="sortTable(this, 9, 'number')">適応力</th>
                    <th class="sortable" onclick="sortTable(this, 10, 'number')">生産力</th>
                    <th class="sortable" onclick="sortTable(this, 11, 'number')">店舗</th>
                    <th class="sortable" onclick="sortTable(this, 12, 'number')">営業</th>
                    <th class="sortable" onclick="sortTable(this, 13, 'number')">人事</th>
                    <th class="sortable" onclick="sortTable(this, 14, 'number')">開発</th>
                    <th class="sortable" onclick="sortTable(this, 15, 'number')">広報</th>
                    <th class="sortable" onclick="sortTable(this, 16, 'number')">経理</th>
                    <th class="sortable" onclick="sortTable(this, 17, 'number')">マネジ</th>
                    <th class="sortable" onclick="sortTable(this, 19, 'number')">役員</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees if emp.role not in ['ceo', 'cxo'] %}
                {% set ns = namespace(div_name='共通部門') %}
                {% for d in player_divisions %}{% if d.id == emp.division_id %}{% set ns.div_name = d.name %}{% endif %}{% endfor %}
                <tr onclick="selectRow(this, '{{ emp.id }}', '{{ emp.name }}', '{{ emp.department }}', '{{ emp.role }}', '{{ emp.salary }}', '{{ emp.division_id }}')" data-dept="{{ emp.department }}" data-role="{{ emp.role }}" data-name="{{ emp.name }}">
                    <td><input type="radio" name="selected_emp" value="{{ emp.id }}"></td>
                    <td>{{ emp.department }}</td>
                    <td>{{ ns.div_name }}</td>
                    <td>{{ emp.role }}</td>
                    <td><a href="{{ url_for('npc_detail', npc_id=emp.id) }}" style="color: #4db8ff; font-weight: bold;" onclick="event.stopPropagation()">{{ emp.name }}</a></td>
                    <td>{{ emp.age }}</td>
                    <td data-value="{{ emp.salary }}">¥{{ "{:,.2f}M".format(emp.salary / 1000000) }}</td>
                    <td data-value="{{ emp.loyalty }}">
                        <div class="bar-container">
                            <div class="bar-fill" style="width: {{ emp.loyalty }}%; background-color: {{ '#e94560' if emp.loyalty < 40 else '#0f3460' }};"></div>
                            <span class="bar-text">{{ emp.loyalty|int }}</span>
                        </div>
                    </td>
                    <td data-value="{{ emp.diligence | perceived_value(hr_power) }}">{{ emp.diligence | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.adaptability | perceived_value(hr_power) }}">{{ emp.adaptability | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.production | perceived_value(hr_power) }}">{{ emp.production | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.store_ops | perceived_value(hr_power) }}">{{ emp.store_ops | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.sales | perceived_value(hr_power) }}">{{ emp.sales | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.hr | perceived_value(hr_power) }}">{{ emp.hr | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.development | perceived_value(hr_power) }}">{{ emp.development | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.pr | perceived_value(hr_power) }}">{{ emp.pr | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.accounting | perceived_value(hr_power) }}">{{ emp.accounting | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.management | perceived_value(hr_power) }}">{{ emp.management | ability_range_colored(hr_power) }}</td>
                    <td data-value="{{ emp.executive | perceived_value(hr_power) }}">{{ emp.executive | ability_range_colored(hr_power) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 配属変更モーダル -->
<div id="modal-dept" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>配属変更</h2>
            <span class="close" onclick="closeModal('modal-dept')">&times;</span>
        </div>
        <form action="{{ url_for('hr_change_dept') }}" method="post">
            <input type="hidden" name="npc_id" id="dept-npc-id">
            <div class="modal-body">
                <h3 id="dept-npc-name">田中 太郎</h3>
                <div class="form-group">
                    <label>現在の配属</label>
                    <div class="current-value" id="dept-current">生産部 メンバー</div>
                </div>
                <div class="form-group">
                    <label>事業部 (直接部門のみ)</label>
                    <select name="new_division_id" id="dept-new-div" class="form-control">
                        <option value="">共通部門 (本社)</option>
                        {% for div in player_divisions %}
                        <option value="{{ div.id }}">{{ div.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>変更後の配属</label>
                    <select name="new_dept" id="dept-new-dept" class="form-control">
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>役職</label>
                    <select name="new_role" id="dept-new-role" class="form-control">
                        <option value="member">メンバー</option>
                        <option value="assistant_manager">部長補佐</option>
                        <option value="manager">部長</option>
                        <option value="cxo">CxO</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">改定</button>
            </div>
        </form>
    </div>
</div>

<!-- 給与変更モーダル -->
<div id="modal-salary" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>給与改定</h2>
            <span class="close" onclick="closeModal('modal-salary')">&times;</span>
        </div>
        <form action="{{ url_for('hr_change_salary') }}" method="post">
            <input type="hidden" name="npc_id" id="salary-npc-id">
            <div class="modal-body">
                <h3 id="salary-npc-name">田中 太郎</h3>
                <div class="form-group">
                    <label>現在の給与</label>
                    <div class="current-value" id="salary-current">¥ 4,250,000</div>
                </div>
                <div class="form-group">
                    <label>改定後の給与</label>
                    <input type="number" name="new_salary" class="form-control input-large" placeholder="金額を入力">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">改定</button>
            </div>
        </form>
    </div>
</div>

<script>
    let selectedNpc = null;

    function selectRow(row, id, name, dept, role, salary, divId) {
        // 選択状態の更新
        document.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        row.querySelector('input[type="radio"]').checked = true;

        selectedNpc = { id, name, dept, role, salary, divId };
    }

    function openDeptModal() {
        if (!selectedNpc) return alert("従業員を選択してください");
        document.getElementById('dept-npc-id').value = selectedNpc.id;
        document.getElementById('dept-npc-name').innerText = selectedNpc.name;
        document.getElementById('dept-current').innerText = `${selectedNpc.dept} / ${selectedNpc.role}`;
        
        // 初期値を現在の値に設定
        document.getElementById('dept-new-dept').value = selectedNpc.dept;
        document.getElementById('dept-new-role').value = selectedNpc.role;
        document.getElementById('dept-new-div').value = selectedNpc.divId || "";
        
        document.getElementById('modal-dept').style.display = 'flex';
    }

    function openSalaryModal() {
        if (!selectedNpc) return alert("従業員を選択してください");
        document.getElementById('salary-npc-id').value = selectedNpc.id;
        document.getElementById('salary-npc-name').innerText = selectedNpc.name;
        document.getElementById('salary-current').innerText = "¥ " + parseInt(selectedNpc.salary).toLocaleString();
        document.getElementById('modal-salary').style.display = 'flex';
    }
    
    function openFireModal() {
        if (!selectedNpc) return alert("従業員を選択してください");
        if(confirm(selectedNpc.name + " を解雇しますか？この操作は取り消せません。")) {
            // フォームを動的に作成して送信
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('hr_fire') }}";
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'npc_id';
            input.value = selectedNpc.id;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // フィルタリング機能
    function filterEmployees() {
        const dept = document.getElementById('emp-filter-dept').value.toLowerCase();
        const role = document.getElementById('emp-filter-role').value.toLowerCase();
        const name = document.getElementById('emp-filter-name').value.toLowerCase();

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            if (!row.hasAttribute('data-name')) return; // データ行以外はスキップ

            const rDept = row.getAttribute('data-dept').toLowerCase();
            const rRole = row.getAttribute('data-role').toLowerCase();
            const rName = row.getAttribute('data-name').toLowerCase();

            let show = true;
            if (dept && rDept !== dept) show = false;
            if (role && rRole !== role) show = false;
            if (name && !rName.includes(name)) show = false;

            row.style.display = show ? '' : 'none';
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // モーダル外クリックで閉じる
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
{% endblock %}
