<!-- c:\0124newSIm\src\templates\dev.html -->
{% extends "base.html" %}

{% block content %}
<div class="dashboard-grid">
    <!-- 新規開発フォーム -->
    <div class="card card-large">
        <div class="card-header">
            <h2>新規プロジェクト開始</h2>
        </div>
        <div class="card-body">
            <!-- キャパシティ予測アラート -->
            <div class="alert-box" style="margin-bottom: 20px; background-color: rgba(15, 52, 96, 0.6); border: 1px solid #4db8ff;">
                <h4 style="margin-top: 0; margin-bottom: 10px; color: #4db8ff; font-size: 1em;">開発キャパシティ予測</h4>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                    <div>
                        <div>現在のキャパシティ: <strong>{{ header_caps.development_capacity|int }}</strong></div>
                        <div>現在の要求値: <strong>{{ header_caps.requirements.development|int }}</strong></div>
                    </div>
                    <div style="text-align: right;">
                        <div>新規プロジェクト要求: <strong>+{{ req_per_project }}</strong></div>
                        <div>開始後の要求値: <strong style="color: {{ '#e94560' if (header_caps.requirements.development + req_per_project) > header_caps.development_capacity else '#b2ff59' }};">
                            {{ (header_caps.requirements.development + req_per_project)|int }}
                        </strong></div>
                    </div>
                </div>
            </div>

            <form action="{{ url_for('dev_start') }}" method="post">
                <div class="form-group">
                    <label>プロジェクト名</label>
                    <input type="text" name="name" class="form-control" placeholder="例: Model Y" required>
                </div>
                
                <div class="form-group">
                    <label>開発対象 (事業部・カテゴリ)</label>
                    <select name="category_key" id="category-select" class="form-control" onchange="updatePartsList()">
                        {% for div in player_divisions %}
                            {% set ind = industries[div.industry_key] %}
                            <optgroup label="{{ div.name }} ({{ ind.name }})">
                                {% for cat_key, cat in ind.categories.items() %}
                                <option value="{{ cat_key }}" data-industry="{{ div.industry_key }}" data-division="{{ div.id }}">
                                    {{ cat.name }} (需要: {{ cat.base_demand }})
                                </option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                    <!-- Hidden inputs to pass industry/division based on selection -->
                    <input type="hidden" name="industry_key" id="input-industry">
                    <input type="hidden" name="division_id" id="input-division">
                </div>

                <div class="form-group">
                    <label>開発方針</label>
                    <select name="strategy" class="form-control">
                        {% for key, strat in strategies.items() %}
                        <option value="{{ key }}">{{ strat.name }} (魅力: x{{ strat.c_mod }}, 効率: x{{ strat.e_mod }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <h3>パーツ選定</h3>
                <div id="parts-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <!-- JS will populate this -->
                </div>
                
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary" id="dev-start-btn">開発開始</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 開発状況 -->
    <div class="card card-large">
        <div class="card-header">
            <h2>プロジェクト状況</h2>
        </div>
        <div class="card-body">
            <h3>進行中</h3>
            <ul class="news-list">
                {% for proj in developing %}
                <li class="news-item">
                    <span class="news-content">
                        <strong>{{ proj.name }}</strong> - 残り {{ duration - (current_week - proj.developed_week) }} 週
                    </span>
                </li>
                {% else %}
                <li class="news-item">進行中のプロジェクトはありません。</li>
                {% endfor %}
            </ul>

            <h3 style="margin-top: 20px;">完了済み製品</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>製品名</th>
                        <th>コンセプト</th>
                        <th>生産効率</th>
                        <th>販売価格</th>
                        <th>認知度</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in completed %}
                    <tr>
                        <td><a href="{{ url_for('product_detail', design_id=prod.id) }}" style="color: #4db8ff;">{{ prod.name }}</a></td>
                        <td>{{ "{:.2f}".format(prod.concept_score) }}</td>
                        <td>{{ "{:.2f}".format(prod.production_efficiency) }}</td>
                        <td>¥{{ "{:,}".format(prod.sales_price) }}</td>
                        <td>{{ "{:.1f}".format(prod.awareness) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Data passed from backend
    const industries = {{ industries | tojson }};
    const suppliers = {{ suppliers_json | safe }};

    function updatePartsList() {
        const select = document.getElementById('category-select');
        const selectedOption = select.options[select.selectedIndex];
        const catKey = select.value;
        const indKey = selectedOption.getAttribute('data-industry');
        const divId = selectedOption.getAttribute('data-division');

        // Update hidden inputs
        document.getElementById('input-industry').value = indKey;
        document.getElementById('input-division').value = divId;

        // Get parts definition
        const category = industries[indKey].categories[catKey];
        const parts = category.parts;
        
        const container = document.getElementById('parts-container');
        container.innerHTML = '';

        parts.forEach(part => {
            const group = document.createElement('div');
            group.className = 'form-group';
            
            const label = document.createElement('label');
            label.innerText = `${part.label} (基準: ¥${part.base_cost.toLocaleString()})`;
            group.appendChild(label);

            const selectPart = document.createElement('select');
            selectPart.name = `part_${part.key}`;
            selectPart.className = 'form-control';

            // Filter suppliers for this part category
            const partSuppliers = suppliers[part.key] || [];
            partSuppliers.forEach(sup => {
                const opt = document.createElement('option');
                opt.value = sup.id;
                opt.innerText = `${sup.name} [品質:${sup.score} / コスト:x${sup.cost_mult}]`;
                selectPart.appendChild(opt);
            });

            group.appendChild(selectPart);
            container.appendChild(group);
        });

        // 開発期間の表示更新
        const duration = category.development_duration;
        const btn = document.getElementById('dev-start-btn');
        if (btn) {
            btn.innerText = `開発開始 (期間: ${duration}週)`;
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updatePartsList);
</script>
{% endblock %}
